<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACMG Secondary Findings Report</title>
    <link rel="stylesheet" href="report.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h4>Whole Genome Sequencing | Clinical Report | Confidential</h4>
            <h1>ACMG Secondary Findings Report</h1>
            <p class="subtitle">Genetic Variant Analysis Based on ACMG SF v3.2 Guidelines</p>
            <p class="report-info" id="reportInfo">Generated on: <span id="reportDate"></span></p>
        </header>

        <!-- Table of Contents -->
        <nav class="table-of-contents">
            <h3>Report Contents</h3>
            <ol>
                <li><a href="#patientSection">Patient Information</a></li>
                <li><a href="#executiveSection">Executive Summary</a></li>
                <li><a href="#findingsSection">Pathogenic/Likely Pathogenic Findings</a></li>
                <li><a href="#carrierSection">Carrier Status (Autosomal Recessive Conditions)</a></li>
                <li><a href="#vusSection">Variants of Uncertain Significance (VUS)</a></li>
                <li><a href="#geneTableSection">Complete Gene Panel Results</a></li>
                <li><a href="#recommendationsSection">Clinical Recommendations</a></li>
            </ol>
        </nav>

        <!-- Section 1: Patient Information -->
        <section class="patient-section" id="patientSection">
            <div class="section-header">
                <span class="section-number">1</span>
                <h2>Patient Information</h2>
            </div>
            <div class="patient-grid">
                <div class="patient-field">
                    <span class="patient-label">Patient ID</span>
                    <span class="patient-value" id="patientId">NA12878</span>
                </div>
                <div class="patient-field">
                    <span class="patient-label">Patient Name</span>
                    <span class="patient-value" id="patientName">—</span>
                </div>
                <div class="patient-field">
                    <span class="patient-label">Date of Birth</span>
                    <span class="patient-value" id="patientDob">—</span>
                </div>
                <div class="patient-field">
                    <span class="patient-label">Sex</span>
                    <span class="patient-value" id="patientSex">—</span>
                </div>
                <div class="patient-field">
                    <span class="patient-label">Sample ID</span>
                    <span class="patient-value" id="sampleId">NA12878.trio</span>
                </div>
                <div class="patient-field">
                    <span class="patient-label">Sample Type</span>
                    <span class="patient-value" id="sampleType">Whole Blood</span>
                </div>
                <div class="patient-field">
                    <span class="patient-label">Collection Date</span>
                    <span class="patient-value" id="collectionDate">—</span>
                </div>
                <div class="patient-field">
                    <span class="patient-label">Ordering Physician</span>
                    <span class="patient-value" id="physician">—</span>
                </div>
            </div>
        </section>

        <!-- Section 2: Executive Summary -->
        <section class="executive-section" id="executiveSection">
            <div class="section-header">
                <span class="section-number">2</span>
                <h2>Executive Summary</h2>
            </div>
            <div class="executive-content" id="executiveSummary">
                <!-- Populated by JavaScript -->
            </div>
            <div class="summary-cards-grid" id="summaryCardsGrid">
                <!-- Populated by JavaScript -->
            </div>
        </section>

        <!-- Section 3: Pathogenic/Likely Pathogenic Findings -->
        <section class="findings-section" id="findingsSection">
            <div class="section-header">
                <span class="section-number">3</span>
                <h2>Pathogenic/Likely Pathogenic Findings</h2>
            </div>

            <!-- Summary Table -->
            <div id="pathogenicSummaryTable">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Detailed Findings -->
            <div id="pathogenicContainer">
                <!-- Populated by JavaScript -->
            </div>
        </section>

        <!-- Section 4: Carrier Status (Autosomal Recessive Conditions) -->
        <section class="findings-section" id="carrierSection">
            <div class="section-header">
                <span class="section-number">4</span>
                <h2>Carrier Status (Autosomal Recessive Conditions)</h2>
            </div>

            <!-- Summary Table -->
            <div id="carrierSummaryTable">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Detailed Findings -->
            <div id="carrierContainer">
                <!-- Populated by JavaScript -->
            </div>
        </section>

        <!-- Section 5: Variants of Uncertain Significance -->
        <section class="findings-section" id="vusSection">
            <div class="section-header">
                <span class="section-number">5</span>
                <h2>Variants of Uncertain Significance (VUS)</h2>
            </div>

            <!-- Summary Table -->
            <div id="vusSummaryTable">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Detailed Findings -->
            <div id="vusContainer">
                <!-- Populated by JavaScript -->
            </div>
        </section>

        <!-- Section 6: Gene Results Table -->
        <section class="gene-table-section" id="geneTableSection">
            <div class="section-header">
                <span class="section-number">6</span>
                <h2>Complete Gene Panel Results</h2>
            </div>

            <div class="table-controls">
                <input type="text" class="search-box" id="searchBox" placeholder="Search genes, conditions...">
                <select class="filter-select" id="resultFilter">
                    <option value="all">All Results</option>
                    <option value="positive">Positive Only</option>
                    <option value="negative">Negative Only</option>
                </select>
                <select class="filter-select" id="diseaseFilter">
                    <option value="all">All Disease Groups</option>
                </select>
            </div>

            <div class="table-container">
                <table class="gene-table" id="geneTable">
                    <thead>
                        <tr>
                            <th data-sort="gene">Gene</th>
                            <th data-sort="disease">Disease Group</th>
                            <th data-sort="condition">Associated Condition</th>
                            <th data-sort="inheritance">Inheritance</th>
                            <th data-sort="result">Result</th>
                        </tr>
                    </thead>
                    <tbody id="geneTableBody">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Section 7: Clinical Recommendations -->
        <section class="findings-section" id="recommendationsSection">
            <div class="section-header" style="border-bottom-color: #16a085;">
                <span class="section-number" style="background: #16a085;">7</span>
                <h2 style="color: #16a085;">Clinical Recommendations</h2>
            </div>
            <p style="margin-bottom: 20px; color: var(--text-muted);">
                Evidence-based clinical recommendations from ClinGen Actionability Working Group for genes with identified variants.
            </p>
            <div id="recommendationsContainer">
                <!-- Populated by JavaScript -->
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <p>This report is generated for research purposes. Clinical interpretation should be performed by qualified professionals.</p>
            <p>ACMG Secondary Findings Pipeline v1.0 | Medygene Research</p>
        </footer>
    </div>

    <script>
        // Data will be loaded from JSON files or embedded
        let geneResults = [];
        let matchingVariants = [];

        // Field descriptions from parameter_reference.csv
        const fieldDescriptions = {
            'Gene (HGNC)': 'Official gene symbol from HUGO Gene Nomenclature Committee',
            'Transcript': 'NCBI Reference Sequence identifier with version number',
            'Genomic Location': 'Chromosome and position on GRCh38/hg38 reference genome',
            'dbSNP ID': 'NCBI dbSNP reference SNP identifier for the variant',
            'cDNA Change (HGVS)': 'HGVS notation describing the change at cDNA level',
            'Protein Change (HGVS)': 'HGVS notation describing the resulting protein change',
            'Genomic Alternation': 'The actual nucleotide change observed in the patient\'s VCF',
            'Variant Type': 'Classification of the variant by its molecular mechanism',
            'Zygosity': 'Whether variant is heterozygous (one copy) or homozygous (two copies)',
            'ACMG Score': 'Computed score based on ACMG/AMP criteria weights (higher = more pathogenic). Very Strong = +8, Strong = +4, Moderate = +2, Supporting = +1 for pathogenic; negative points for benign.',
            'ACMG/AMP Criteria Applied': 'Applied ACMG/AMP evidence criteria: PVS=very strong, PS=strong, PM=moderate, PP=supporting pathogenic; BA/BS/BP=benign',
            'Final Classification': 'Overall pathogenicity classification: Pathogenic, Likely Pathogenic, VUS, Likely Benign, Benign',
            'Biotype': 'Type of transcript: protein coding, nonsense mediated decay, pseudogene, etc.',
            'ClinVar ID': 'Unique ClinVar Variation accession (VCV) for looking up the variant',
            'ClinVar Review Status': 'Review level: 4 stars=practice guideline, 3 stars=expert panel, 2 stars=multiple submitters, 1 star=single submitter',
            'ClinVar Submissions Summary': 'Format is Classification:Count. P=Pathogenic, LP=Likely Pathogenic, VUS=Uncertain, LB=Likely Benign, B=Benign. Example: P:3,LP:1 means 3 labs said Pathogenic, 1 said Likely Pathogenic',
            'Associated Condition': 'The disease or phenotype associated with pathogenic variants in this gene',
            'Inheritance Pattern': 'How the condition is inherited: AD=autosomal dominant, AR=autosomal recessive, XL=X-linked',
            'ClinGen Gene-Disease Validity': 'ClinGen\'s assessment: Definitive, Strong, Moderate, Limited, Disputed, Refuted',
            'Key Publications': 'PubMed IDs of publications supporting the variant\'s clinical significance',
            'Protein Name': 'Official protein name from UniProt database',
            'Protein Function': 'Description of what the protein does, from UniProt',
            'Severity': 'ClinGen severity score: 3=High (sudden death), 2=Moderate (serious morbidity), 1=Low (modest morbidity)',
            'Outcomes': 'Target health outcomes that interventions aim to prevent or mitigate',
            'Interventions': 'Available medical interventions, treatments, or risk-reducing procedures from ClinGen Actionability'
        };

        // Patient information (can be set programmatically)
        let patientInfo = {
            patientId: 'NA12878',
            patientName: '—',
            patientDob: '—',
            patientSex: '—',
            sampleId: 'NA12878.trio',
            sampleType: 'Whole Blood',
            collectionDate: '—',
            physician: '—'
        };

        // Initialize the report
        async function initReport() {
            try {
                // Try to load from JSON files (relative paths)
                const [geneResponse, variantResponse] = await Promise.all([
                    fetch('gene_results.json').catch(() => null),
                    fetch('matching_variants.json').catch(() => null)
                ]);

                if (geneResponse && geneResponse.ok) {
                    geneResults = await geneResponse.json();
                }
                if (variantResponse && variantResponse.ok) {
                    matchingVariants = await variantResponse.json();
                }
            } catch (e) {
                console.log('Using embedded data or data needs to be provided');
            }

            // Set report date
            document.getElementById('reportDate').textContent = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            renderPatientInfo();
            renderExecutiveSummary();
            renderSummaryCards();
            renderAllFindings();
            renderGeneTable();
            renderClinicalRecommendations();
            setupEventListeners();
        }

        // Categorize variants into three groups
        function categorizeVariants() {
            const pathogenic = [];
            const carrier = [];
            const vus = [];

            matchingVariants.forEach((variant, index) => {
                const findingKey = Object.keys(variant)[0];
                const finding = variant[findingKey];
                const acmgInfo = finding['ACMG Information'] || {};
                const clinvarInfo = finding['ClinVar Information'] || {};

                const finalClassification = (acmgInfo['Final Classification'] || '').toLowerCase();
                const inheritancePattern = (clinvarInfo['Inheritance Pattern'] || '').toLowerCase();

                // Check if VUS (Uncertain significance)
                if (finalClassification.includes('uncertain') || finalClassification.includes('vus')) {
                    vus.push({ variant, index, findingKey, finding });
                }
                // Check if Carrier (Autosomal recessive)
                else if (inheritancePattern.includes('autosomal recessive') || inheritancePattern.includes('ar')) {
                    carrier.push({ variant, index, findingKey, finding });
                }
                // Otherwise it's Pathogenic/Likely Pathogenic
                else {
                    pathogenic.push({ variant, index, findingKey, finding });
                }
            });

            return { pathogenic, carrier, vus };
        }

        function renderPatientInfo() {
            document.getElementById('patientId').textContent = patientInfo.patientId;
            document.getElementById('patientName').textContent = patientInfo.patientName;
            document.getElementById('patientDob').textContent = patientInfo.patientDob;
            document.getElementById('patientSex').textContent = patientInfo.patientSex;
            document.getElementById('sampleId').textContent = patientInfo.sampleId;
            document.getElementById('sampleType').textContent = patientInfo.sampleType;
            document.getElementById('collectionDate').textContent = patientInfo.collectionDate;
            document.getElementById('physician').textContent = patientInfo.physician;
        }

        function renderExecutiveSummary() {
            const totalGenes = geneResults.length;
            const positiveResults = geneResults.filter(g => g.Result.toLowerCase() === 'positive').length;
            const positiveGenes = geneResults.filter(g => g.Result.toLowerCase() === 'positive').map(g => g.Gene);

            // Categorize variants
            const categories = categorizeVariants();
            const pathogenicCount = categories.pathogenic.length;
            const carrierCount = categories.carrier.length;
            const vusCount = categories.vus.length;

            let summaryHTML = '';
            const hasFindings = pathogenicCount > 0 || carrierCount > 0 || vusCount > 0;

            if (hasFindings) {
                const geneList = positiveGenes.join(', ');

                summaryHTML = `
                    <p>This report presents the results of genetic screening for <strong>${totalGenes} genes</strong> associated with conditions recommended for secondary findings disclosure by the American College of Medical Genetics and Genomics (ACMG SF v3.2).</p>

                    ${pathogenicCount > 0 ? `
                    <div class="executive-highlight positive-findings">
                        <strong>Actionable Findings Detected:</strong> This analysis identified <strong>${pathogenicCount} pathogenic/likely pathogenic variant(s)</strong> in autosomal dominant genes requiring immediate clinical attention.
                    </div>
                    ` : ''}

                    ${carrierCount > 0 ? `
                    <div class="executive-highlight" style="background: #d6eaf8; border-left-color: var(--secondary-color);">
                        <strong>Carrier Status Identified:</strong> This analysis identified <strong>${carrierCount} variant(s)</strong> in autosomal recessive genes. The individual is a carrier and may pass this variant to offspring.
                    </div>
                    ` : ''}

                    ${vusCount > 0 ? `
                    <div class="executive-highlight" style="background: #f4f6f6; border-left-color: #7f8c8d;">
                        <strong>⚠️ Variants of Uncertain Significance:</strong> This analysis identified <strong>${vusCount} VUS variant(s)</strong>. These variants require additional evidence for clinical interpretation.
                    </div>
                    ` : ''}

                    <p>Detailed information about each variant, including genomic location, clinical associations, and supporting evidence, is provided in the sections below. Genetic counseling is recommended to discuss the implications of these findings.</p>
                `;
            } else {
                summaryHTML = `
                    <p>This report presents the results of genetic screening for <strong>${totalGenes} genes</strong> associated with conditions recommended for secondary findings disclosure by the American College of Medical Genetics and Genomics (ACMG SF v3.2).</p>

                    <div class="executive-highlight no-findings">
                        <strong>No Actionable Findings:</strong> This analysis did not identify any pathogenic, likely pathogenic, carrier status, or VUS variants in the genes screened.
                    </div>

                    <p>A negative result indicates that no clinically significant variants were detected in the genes analyzed. However, this does not eliminate genetic risk, as variants in genes not included in this panel or variants not detectable by current methods may still be present.</p>
                `;
            }

            document.getElementById('executiveSummary').innerHTML = summaryHTML;
        }

        function renderSummaryCards() {
            const totalGenes = geneResults.length;
            const positiveResults = geneResults.filter(g => g.Result.toLowerCase() === 'positive').length;
            const negativeResults = totalGenes - positiveResults;

            // Categorize variants
            const categories = categorizeVariants();
            const pathogenicCount = categories.pathogenic.length;
            const carrierCount = categories.carrier.length;
            const vusCount = categories.vus.length;

            const cardsHTML = `
                <div class="summary-card">
                    <div class="number">${totalGenes}</div>
                    <div class="label">Genes Analyzed</div>
                </div>
                <div class="summary-card positive">
                    <div class="number">${pathogenicCount}</div>
                    <div class="label">Pathogenic/Likely Path.</div>
                </div>
                <div class="summary-card" style="border-left-color: var(--secondary-color);">
                    <div class="number" style="color: var(--secondary-color);">${carrierCount}</div>
                    <div class="label">Carrier Status</div>
                </div>
                <div class="summary-card" style="border-left-color: #7f8c8d;">
                    <div class="number" style="color: #7f8c8d;">${vusCount}</div>
                    <div class="label">VUS ⚠️</div>
                </div>
                <div class="summary-card negative">
                    <div class="number">${negativeResults}</div>
                    <div class="label">Negative Results</div>
                </div>
            `;

            document.getElementById('summaryCardsGrid').innerHTML = cardsHTML;
        }

        function renderAllFindings() {
            const categories = categorizeVariants();

            renderCategoryFindings('pathogenic', categories.pathogenic, 'pathogenicSummaryTable', 'pathogenicContainer');
            renderCategoryFindings('carrier', categories.carrier, 'carrierSummaryTable', 'carrierContainer');
            renderCategoryFindings('vus', categories.vus, 'vusSummaryTable', 'vusContainer');
        }

        function renderCategoryFindings(category, variants, tableContainerId, detailContainerId) {
            const tableContainer = document.getElementById(tableContainerId);
            const detailContainer = document.getElementById(detailContainerId);

            if (variants.length === 0) {
                let message = '';
                if (category === 'pathogenic') {
                    message = 'No pathogenic or likely pathogenic variants detected in autosomal dominant genes.';
                } else if (category === 'carrier') {
                    message = 'No carrier status variants detected in autosomal recessive genes.';
                } else if (category === 'vus') {
                    message = 'No variants of uncertain significance detected.';
                }
                tableContainer.innerHTML = `<p class="no-findings-message">${message}</p>`;
                detailContainer.innerHTML = '';
                return;
            }

            // Render summary table
            const tableClass = category === 'carrier' ? 'carrier' : (category === 'vus' ? 'vus' : '');
            let tableHTML = `
                <table class="findings-summary-table ${tableClass}">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Gene</th>
                            <th>Classification</th>
                            <th>Variant (HGVS)</th>
                            <th>Condition</th>
                            <th>Inheritance</th>
                            <th>Zygosity</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            variants.forEach((item, idx) => {
                const { finding, findingKey } = item;
                const match = findingKey.match(/Finding \d+: (\w+) - (.+)/);
                const geneName = match ? match[1] : '—';
                const classification = match ? match[2] : 'Unknown';

                let badgeClass = 'pathogenic';
                if (category === 'carrier') badgeClass = 'carrier';
                else if (category === 'vus') badgeClass = 'vus';
                else if (classification.toLowerCase().includes('likely')) badgeClass = 'likely-pathogenic';

                const basicInfo = finding['Basic Information'] || {};
                const clinvarInfo = finding['ClinVar Information'] || {};
                const acmgInfo = finding['ACMG Information'] || {};

                const hgvs = basicInfo['cDNA Change (HGVS)'] || '—';
                const condition = clinvarInfo['Associated Condition'] || '—';
                const inheritance = clinvarInfo['Inheritance Pattern'] || '—';
                const zygosity = basicInfo['Zygosity'] || '—';

                // For VUS, show the actual classification from ACMG
                let displayClassification = classification;
                if (category === 'vus') {
                    displayClassification = acmgInfo['Final Classification'] || 'VUS';
                    displayClassification = displayClassification.replace(/_/g, ' ');
                }

                tableHTML += `
                    <tr>
                        <td><strong>${idx + 1}</strong></td>
                        <td><strong>${geneName}</strong></td>
                        <td><span class="classification-badge ${badgeClass}">${category === 'vus' ? '⚠️ ' + displayClassification : displayClassification}</span></td>
                        <td>${hgvs}</td>
                        <td>${condition}</td>
                        <td>${inheritance}</td>
                        <td>${zygosity}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
                <h3 style="margin: 30px 0 20px 0; color: ${category === 'carrier' ? 'var(--secondary-color)' : (category === 'vus' ? '#7f8c8d' : 'var(--primary-color)')};">Detailed Variant Information</h3>
            `;

            tableContainer.innerHTML = tableHTML;

            // Render detailed cards
            let findingsHTML = '';

            variants.forEach((item, idx) => {
                const { finding, findingKey } = item;
                const match = findingKey.match(/Finding \d+: (\w+) - (.+)/);
                const geneName = match ? match[1] : findingKey;
                const classification = match ? match[2] : 'Unknown';
                const acmgInfo = finding['ACMG Information'] || {};

                let headerClass = '';
                let displayClassification = classification;
                let titlePrefix = '';

                if (category === 'carrier') {
                    headerClass = 'carrier';
                    titlePrefix = '';
                    displayClassification = 'Carrier';
                } else if (category === 'vus') {
                    headerClass = 'vus';
                    titlePrefix = '⚠️ ';
                    displayClassification = (acmgInfo['Final Classification'] || 'VUS').replace(/_/g, ' ');
                } else if (classification.toLowerCase().includes('likely pathogenic')) {
                    headerClass = 'likely-pathogenic';
                }

                findingsHTML += `
                    <div class="finding-card">
                        <div class="finding-header ${headerClass}">
                            <h3>${titlePrefix}Finding ${idx + 1}: ${geneName} Variant</h3>
                            <span class="classification">${displayClassification}</span>
                        </div>
                        <div class="finding-body">
                            <div class="info-grid">
                                ${renderInfoSection('Basic Information', finding['Basic Information'])}
                                ${renderInfoSection('Gene & Protein Information', finding['Gene & Protein Information'])}
                                ${renderInfoSection('ClinVar Information', finding['ClinVar Information'])}
                                ${renderInfoSection('ACMG Information', finding['ACMG Information'])}
                                ${renderInfoSection('Additional Parameters', finding['Additional Parameters'])}
                            </div>
                        </div>
                    </div>
                `;
            });

            detailContainer.innerHTML = findingsHTML;
        }

        function renderInfoSection(title, data) {
            if (!data) return '';

            let rowsHTML = '';
            for (const [key, value] of Object.entries(data)) {
                const description = fieldDescriptions[key] || '';
                const tooltipHTML = description ? `
                    <span class="tooltip-icon">?
                        <span class="tooltip-content">${description}</span>
                    </span>
                ` : '';

                // Handle array values (for list fields like Surveillance, Interventions, etc.)
                let displayValue = '';
                let isNotAvailable = false;

                if (Array.isArray(value)) {
                    if (value.length === 0) {
                        isNotAvailable = true;
                        displayValue = 'None specified';
                    } else {
                        displayValue = '<ul style="margin: 0; padding-left: 20px; list-style-type: disc;">' +
                            value.map(item => `<li style="margin-bottom: 4px;">${item}</li>`).join('') +
                            '</ul>';
                    }
                } else {
                    isNotAvailable = !value || value === 'Not available' || value === 'Not fetched' || value === 'None cited' || value === 'Not evaluated';
                    displayValue = value || 'Not available';
                }

                const valueClass = isNotAvailable ? 'not-available' : '';

                rowsHTML += `
                    <div class="info-row">
                        <div class="info-label-container">
                            <span class="info-label">${key}</span>
                            ${tooltipHTML}
                        </div>
                        <span class="info-value ${valueClass}">${displayValue}</span>
                    </div>
                `;
            }

            let headerClass = '';
            if (title === 'Clinical Recommendations') {
                headerClass = 'actionability-header';
            } else if (title === 'Gene & Protein Information') {
                headerClass = 'gene-protein-header';
            }

            return `
                <div class="info-section">
                    <h4 class="${headerClass}">${title}</h4>
                    <div class="info-section-content">
                        ${rowsHTML}
                    </div>
                </div>
            `;
        }

        function renderGeneTable(filteredData = null) {
            const data = filteredData || geneResults;
            const tbody = document.getElementById('geneTableBody');

            let rowsHTML = '';
            data.forEach(gene => {
                const isPositive = gene.Result.toLowerCase() === 'positive';
                const rowClass = isPositive ? 'positive-row' : '';
                const badgeClass = isPositive ? 'positive' : 'negative';

                rowsHTML += `
                    <tr class="${rowClass}">
                        <td><strong>${gene.Gene}</strong></td>
                        <td>${gene['Disease Group']}</td>
                        <td>${gene['Associated Condition']}</td>
                        <td>${gene.Inheritance}</td>
                        <td><span class="result-badge ${badgeClass}">${gene.Result}</span></td>
                    </tr>
                `;
            });

            tbody.innerHTML = rowsHTML;

            // Populate disease filter dropdown
            const diseaseGroups = [...new Set(geneResults.map(g => g['Disease Group']))].sort();
            const diseaseFilter = document.getElementById('diseaseFilter');
            if (diseaseFilter.options.length <= 1) {
                diseaseGroups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    diseaseFilter.appendChild(option);
                });
            }
        }

        function renderClinicalRecommendations() {
            const container = document.getElementById('recommendationsContainer');

            if (matchingVariants.length === 0) {
                container.innerHTML = '<p class="no-recommendations">No variants identified, therefore no clinical recommendations to display.</p>';
                return;
            }

            let recommendationsHTML = '';
            const seenGenes = new Set();

            matchingVariants.forEach((variant, index) => {
                const findingKey = Object.keys(variant)[0];
                const finding = variant[findingKey];
                const actionability = finding['Clinical Actionability'];
                const basicInfo = finding['Basic Information'] || {};
                const clinvarInfo = finding['ClinVar Information'] || {};

                const geneName = basicInfo['Gene (HGNC)'] || 'Unknown Gene';

                // Skip if we've already rendered recommendations for this gene
                if (seenGenes.has(geneName)) return;
                seenGenes.add(geneName);

                // Check if there are actual recommendations
                if (!actionability) return;

                const outcomes = actionability['Outcomes'] || [];
                const interventions = actionability['Interventions'] || [];

                // Skip if no actionability data
                if (outcomes.length === 0 && interventions.length === 0) return;

                const severity = actionability['Severity'] || 'Not evaluated';
                const condition = clinvarInfo['Associated Condition'] || '';

                recommendationsHTML += `
                    <div class="recommendation-card">
                        <div class="recommendation-header">
                            <h3>${geneName}${condition ? ` - ${condition}` : ''}</h3>
                            <span class="evidence-badge">Severity: ${severity}</span>
                        </div>
                        <div class="recommendation-body">
                            <div class="recommendation-grid">
                                ${outcomes.length > 0 ? `
                                <div class="recommendation-list">
                                    <h4><span class="list-icon"></span> Outcomes</h4>
                                    <ul>
                                        ${outcomes.map(item => `<li>${item}</li>`).join('')}
                                    </ul>
                                </div>
                                ` : ''}

                                ${interventions.length > 0 ? `
                                <div class="recommendation-list">
                                    <h4><span class="list-icon"></span> Interventions</h4>
                                    <ul>
                                        ${interventions.map(item => `<li>${item}</li>`).join('')}
                                    </ul>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            if (!recommendationsHTML) {
                container.innerHTML = '<p class="no-recommendations">No clinical recommendations available for the identified variants.</p>';
            } else {
                container.innerHTML = recommendationsHTML;
            }
        }

        function setupEventListeners() {
            document.getElementById('searchBox').addEventListener('input', filterTable);
            document.getElementById('resultFilter').addEventListener('change', filterTable);
            document.getElementById('diseaseFilter').addEventListener('change', filterTable);

            document.querySelectorAll('.gene-table th').forEach(th => {
                th.addEventListener('click', () => sortTable(th.dataset.sort));
            });
        }

        function filterTable() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const resultFilter = document.getElementById('resultFilter').value;
            const diseaseFilter = document.getElementById('diseaseFilter').value;

            const filtered = geneResults.filter(gene => {
                const matchesSearch = !searchTerm ||
                    gene.Gene.toLowerCase().includes(searchTerm) ||
                    gene['Disease Group'].toLowerCase().includes(searchTerm) ||
                    gene['Associated Condition'].toLowerCase().includes(searchTerm);

                const matchesResult = resultFilter === 'all' ||
                    gene.Result.toLowerCase() === resultFilter;

                const matchesDisease = diseaseFilter === 'all' ||
                    gene['Disease Group'] === diseaseFilter;

                return matchesSearch && matchesResult && matchesDisease;
            });

            renderGeneTable(filtered);
        }

        let sortDirection = {};
        function sortTable(column) {
            const columnMap = {
                'gene': 'Gene',
                'disease': 'Disease Group',
                'condition': 'Associated Condition',
                'inheritance': 'Inheritance',
                'result': 'Result'
            };

            const key = columnMap[column];
            sortDirection[column] = !sortDirection[column];

            const sorted = [...geneResults].sort((a, b) => {
                const valA = a[key].toLowerCase();
                const valB = b[key].toLowerCase();

                if (sortDirection[column]) {
                    return valA.localeCompare(valB);
                } else {
                    return valB.localeCompare(valA);
                }
            });

            renderGeneTable(sorted);
        }

        // Function to load data programmatically
        function loadData(geneData, variantData, patientData = null) {
            geneResults = geneData;
            matchingVariants = variantData;
            if (patientData) {
                patientInfo = { ...patientInfo, ...patientData };
            }
            renderPatientInfo();
            renderExecutiveSummary();
            renderSummaryCards();
            renderAllFindings();
            renderGeneTable();
            renderClinicalRecommendations();
        }

        // Function to set patient information
        function setPatientInfo(data) {
            patientInfo = { ...patientInfo, ...data };
            renderPatientInfo();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initReport);
    </script>
</body>
</html>
